#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

CONFIG_FILE="$BUILD_DIR/.buildpack-config"
VENDOR_DIR="$BUILD_DIR/vendor"
JAR_DIR="$VENDOR_DIR/jars"
CLONE_DIR="$BUILD_DIR/.build-temp"

indent() {
  sed -u 's/^/       /'
}

echo "-----> GitHub Build-from-Source Buildpack"

# Read GITHUB_TOKEN from environment if available
if [ -d "$ENV_DIR" ] && [ -f "$ENV_DIR/GITHUB_TOKEN" ]; then
  GITHUB_TOKEN=$(cat "$ENV_DIR/GITHUB_TOKEN")
  echo "Using GitHub token for authentication" | indent
fi

# Check if config file exists
if [ ! -f "$CONFIG_FILE" ]; then
  echo "ERROR: .buildpack-config file not found!" | indent
  exit 1
fi

# Parse configuration
echo "-----> Reading configuration from .buildpack-config"
source "$CONFIG_FILE"

# Validate required configuration
if [ -z "$GITHUB_REPO_OWNER" ] || [ -z "$GITHUB_REPO_NAME" ]; then
  echo "ERROR: GITHUB_REPO_OWNER and GITHUB_REPO_NAME must be set in .buildpack-config" | indent
  exit 1
fi

# Set defaults
BRANCH=${BRANCH:-"main"}
BUILD_TOOL=${BUILD_TOOL:-"auto"}

echo "Repository: $GITHUB_REPO_OWNER/$GITHUB_REPO_NAME" | indent
echo "Branch: $BRANCH" | indent
echo "Build Tool: $BUILD_TOOL" | indent

# Create directories
mkdir -p "$JAR_DIR"
mkdir -p "$CLONE_DIR"

# Install GitHub CLI if needed (for private repos or easier auth)
echo "-----> Installing GitHub CLI"
GH_VERSION="2.40.0"
GH_CACHE="$CACHE_DIR/gh-cli"

if [ -f "$GH_CACHE/bin/gh" ]; then
  echo "Using cached GitHub CLI" | indent
  export PATH="$GH_CACHE/bin:$PATH"
else
  echo "Downloading GitHub CLI v$GH_VERSION" | indent
  GH_URL="https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_amd64.tar.gz"
  
  curl -sL "$GH_URL" | tar -xz -C /tmp
  mkdir -p "$GH_CACHE"
  cp -r /tmp/gh_${GH_VERSION}_linux_amd64/* "$GH_CACHE/"
  export PATH="$GH_CACHE/bin:$PATH"
  
  if command -v gh &> /dev/null; then
    echo "GitHub CLI installed successfully" | indent
  else
    echo "ERROR: Failed to install GitHub CLI" | indent
    exit 1
  fi
fi

# Set up git authentication
if [ -n "$GITHUB_TOKEN" ]; then
  git config --global credential.helper store
  echo "https://$GITHUB_TOKEN:x-oauth-basic@github.com" > ~/.git-credentials
fi

# Clone the repository
echo "-----> Cloning repository"
REPO_URL="https://github.com/$GITHUB_REPO_OWNER/$GITHUB_REPO_NAME.git"

if [ -n "$GITHUB_TOKEN" ]; then
  REPO_URL="https://$GITHUB_TOKEN@github.com/$GITHUB_REPO_OWNER/$GITHUB_REPO_NAME.git"
fi

if git clone --depth 1 --branch "$BRANCH" "$REPO_URL" "$CLONE_DIR/repo" 2>&1 | indent; then
  echo "Repository cloned successfully" | indent
else
  echo "ERROR: Failed to clone repository" | indent
  exit 1
fi

cd "$CLONE_DIR/repo"

# Detect build tool if set to auto
if [ "$BUILD_TOOL" == "auto" ]; then
  if [ -f "pom.xml" ]; then
    BUILD_TOOL="maven"
    echo "Detected Maven project" | indent
  elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
    BUILD_TOOL="gradle"
    echo "Detected Gradle project" | indent
  else
    echo "ERROR: Could not detect build tool. Please set BUILD_TOOL in .buildpack-config" | indent
    exit 1
  fi
fi

# Install Java if not present
echo "-----> Setting up Java"
if ! command -v java &> /dev/null; then
  echo "Installing Java..." | indent
  JAVA_VERSION="11"
  JAVA_CACHE="$CACHE_DIR/jdk"
  
  if [ -d "$JAVA_CACHE" ]; then
    echo "Using cached JDK" | indent
    export JAVA_HOME="$JAVA_CACHE"
    export PATH="$JAVA_HOME/bin:$PATH"
  else
    echo "Downloading OpenJDK $JAVA_VERSION" | indent
    JDK_URL="https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.21%2B9/OpenJDK11U-jdk_x64_linux_hotspot_11.0.21_9.tar.gz"
    
    curl -sL "$JDK_URL" | tar -xz -C "$CACHE_DIR"
    mv "$CACHE_DIR/jdk-11.0.21+9" "$JAVA_CACHE"
    export JAVA_HOME="$JAVA_CACHE"
    export PATH="$JAVA_HOME/bin:$PATH"
    
    echo "Java installed successfully" | indent
  fi
else
  echo "Using existing Java installation" | indent
  java -version 2>&1 | indent
fi

# Build the project
echo "-----> Building project with $BUILD_TOOL"

case "$BUILD_TOOL" in
  maven)
    # Install Maven if not present
    if ! command -v mvn &> /dev/null; then
      echo "Installing Maven..." | indent
      MVN_VERSION="3.9.5"
      MVN_CACHE="$CACHE_DIR/maven"
      
      if [ -d "$MVN_CACHE" ]; then
        echo "Using cached Maven" | indent
        export PATH="$MVN_CACHE/bin:$PATH"
      else
        MVN_URL="https://archive.apache.org/dist/maven/maven-3/${MVN_VERSION}/binaries/apache-maven-${MVN_VERSION}-bin.tar.gz"
        curl -sL "$MVN_URL" | tar -xz -C "$CACHE_DIR"
        mv "$CACHE_DIR/apache-maven-${MVN_VERSION}" "$MVN_CACHE"
        export PATH="$MVN_CACHE/bin:$PATH"
        echo "Maven installed successfully" | indent
      fi
    fi
    
    echo "Running: mvn clean package -DskipTests" | indent
    if mvn clean package -DskipTests 2>&1 | indent; then
      echo "Build successful" | indent
      
      # Find the built JAR
      if [ -n "$JAR_NAME_PATTERN" ]; then
        BUILT_JAR=$(find target -name "$JAR_NAME_PATTERN" -type f | head -n 1)
      else
        BUILT_JAR=$(find target -name "*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" -type f | head -n 1)
      fi
    else
      echo "ERROR: Maven build failed" | indent
      exit 1
    fi
    ;;
    
  gradle)
    # Use Gradle wrapper if available
    if [ -f "gradlew" ]; then
      chmod +x gradlew
      GRADLE_CMD="./gradlew"
    elif command -v gradle &> /dev/null; then
      GRADLE_CMD="gradle"
    else
      echo "Installing Gradle..." | indent
      GRADLE_VERSION="8.5"
      GRADLE_CACHE="$CACHE_DIR/gradle"
      
      if [ -d "$GRADLE_CACHE" ]; then
        echo "Using cached Gradle" | indent
        export PATH="$GRADLE_CACHE/bin:$PATH"
      else
        GRADLE_URL="https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
        curl -sL "$GRADLE_URL" -o /tmp/gradle.zip
        unzip -q /tmp/gradle.zip -d "$CACHE_DIR"
        mv "$CACHE_DIR/gradle-${GRADLE_VERSION}" "$GRADLE_CACHE"
        export PATH="$GRADLE_CACHE/bin:$PATH"
        echo "Gradle installed successfully" | indent
      fi
      GRADLE_CMD="gradle"
    fi
    
    echo "Running: $GRADLE_CMD clean build -x test" | indent
    if $GRADLE_CMD clean build -x test 2>&1 | indent; then
      echo "Build successful" | indent
      
      # Find the built JAR
      if [ -n "$JAR_NAME_PATTERN" ]; then
        BUILT_JAR=$(find build/libs -name "$JAR_NAME_PATTERN" -type f | head -n 1)
      else
        BUILT_JAR=$(find build/libs -name "*.jar" ! -name "*-plain.jar" ! -name "*-sources.jar" -type f | head -n 1)
      fi
    else
      echo "ERROR: Gradle build failed" | indent
      exit 1
    fi
    ;;
    
  *)
    echo "ERROR: Unsupported build tool: $BUILD_TOOL" | indent
    echo "Supported tools: maven, gradle, auto" | indent
    exit 1
    ;;
esac

# Verify JAR was built
if [ -z "$BUILT_JAR" ] || [ ! -f "$BUILT_JAR" ]; then
  echo "ERROR: Could not find built JAR file" | indent
  echo "Available JARs:" | indent
  find . -name "*.jar" -type f | indent
  exit 1
fi

# Extract JAR filename
JAR_FILENAME=$(basename "$BUILT_JAR")
echo "Found JAR: $JAR_FILENAME" | indent

# Copy JAR to vendor directory
cp "$BUILT_JAR" "$JAR_DIR/$JAR_FILENAME"
JAR_SIZE=$(du -h "$JAR_DIR/$JAR_FILENAME" | cut -f1)
echo "-----> JAR file ready: $JAR_FILENAME ($JAR_SIZE)" | indent

# Clean up clone directory
cd "$BUILD_DIR"
rm -rf "$CLONE_DIR"

# Create profile.d script to add JAR to classpath and optionally start it
PROFILE_DIR="$BUILD_DIR/.profile.d"
mkdir -p "$PROFILE_DIR"

# Set default for AUTO_START if not specified
AUTO_START=${AUTO_START:-"false"}

if [ "$AUTO_START" == "true" ]; then
  echo "-----> JAR will auto-start as background process at runtime" | indent
  
  cat > "$PROFILE_DIR/github-jar-loader.sh" <<EOF
# Add downloaded JAR to classpath
export CLASSPATH="\$HOME/vendor/jars/*:\$CLASSPATH"

# Start JAR in background if not already running
if [ ! -f /tmp/github-jar.pid ] || ! ps -p \$(cat /tmp/github-jar.pid 2>/dev/null) > /dev/null 2>&1; then
  echo "Starting background JAR: $JAR_FILENAME"
  nohup java $JVM_OPTIONS -jar "\$HOME/vendor/jars/$JAR_FILENAME" > "\$HOME/logs/github-jar.log" 2>&1 &
  echo \$! > /tmp/github-jar.pid
  echo "Background JAR started with PID \$(cat /tmp/github-jar.pid)"
else
  echo "Background JAR already running with PID \$(cat /tmp/github-jar.pid)"
fi
EOF

  # Create logs directory
  mkdir -p "$BUILD_DIR/logs"
  
  echo "JAR will start automatically in background" | indent
  echo "Logs: \$HOME/logs/github-jar.log" | indent
  echo "PID file: /tmp/github-jar.pid" | indent
else
  cat > "$PROFILE_DIR/github-jar-loader.sh" <<'EOF'
# Add downloaded JAR to classpath
export CLASSPATH="$HOME/vendor/jars/*:$CLASSPATH"
EOF
  
  echo "-----> JAR will be available in classpath at runtime" | indent
fi

echo "Location: \$HOME/vendor/jars/$JAR_FILENAME" | indent

echo "-----> Build complete!"
